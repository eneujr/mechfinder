{% extends "base.html" %}

{% block title %}Buscar - MechFinder{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-3">
            <i class="fas fa-search me-2"></i>Busca Inteligente
        </h2>

        <!-- Tabs de Busca -->
        <ul class="nav nav-tabs mb-3" id="searchTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="text-search-tab" data-bs-toggle="tab" data-bs-target="#text-search"
                    type="button" role="tab">
                    <i class="fas fa-keyboard me-2"></i>Busca por Texto
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="image-search-tab" data-bs-toggle="tab" data-bs-target="#image-search"
                    type="button" role="tab">
                    <i class="fas fa-camera me-2"></i>Busca por Imagem
                </button>
            </li>
        </ul>

        <!-- Conteúdo das Tabs -->
        <div class="tab-content" id="searchTabContent">
            <!-- Tab 1: Busca por Texto -->
            <div class="tab-pane fade show active" id="text-search" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <form action="{{ url_for('main.search') }}" method="GET" class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" name="q"
                                        placeholder="Buscar produtos ou serviços..." value="{{ search_query or '' }}"
                                        autofocus>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-lg" name="category">
                                    <option value="all">Todas as Categorias</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat }}" {% if category==cat %}selected{% endif %}>
                                        {{ cat|title }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                                    <i class="fas fa-search me-2"></i>Buscar
                                </button>
                                <a href="{{ url_for('main.search') }}" class="btn btn-outline-secondary btn-lg"
                                    title="Limpar">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                        </form>

                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                <strong>Dica:</strong> Use palavras-chave como "freio", "óleo", "suspensão", etc.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Busca por Imagem -->
            <div class="tab-pane fade" id="image-search" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Busca por IA:</strong> Tire uma foto ou faça upload de uma imagem da peça.
                            Nossa inteligência artificial irá encontrar produtos similares!
                        </div>

                        <!-- Sub-tabs: Câmera e Upload -->
                        <ul class="nav nav-pills mb-3" id="imageTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="camera-tab" data-bs-toggle="pill"
                                    data-bs-target="#camera" type="button" role="tab">
                                    <i class="fas fa-video me-2"></i>Capturar Foto
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="upload-tab" data-bs-toggle="pill" data-bs-target="#upload"
                                    type="button" role="tab">
                                    <i class="fas fa-upload me-2"></i>Fazer Upload
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="imageTabContent">
                            <!-- Câmera -->
                            <div class="tab-pane fade show active" id="camera" role="tabpanel">
                                <div class="text-center mb-3">
                                    <video id="cameraStream" autoplay playsinline
                                        style="max-width: 100%; border-radius: 8px; display: none;"></video>
                                    <canvas id="photoCanvas" style="display: none;"></canvas>
                                    <img id="capturedPhoto" src="" alt="Foto capturada"
                                        style="max-width: 100%; border-radius: 8px; display: none;">
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-success btn-lg" id="startCameraBtn">
                                        <i class="fas fa-video me-2"></i>Iniciar Câmera
                                    </button>
                                    <button type="button" class="btn btn-primary btn-lg" id="captureBtn"
                                        style="display: none;">
                                        <i class="fas fa-camera me-2"></i>Tirar Foto
                                    </button>
                                    <button type="button" class="btn btn-warning btn-lg" id="retakeBtn"
                                        style="display: none;">
                                        <i class="fas fa-redo me-2"></i>Tirar Outra Foto
                                    </button>
                                    <button type="button" class="btn btn-primary btn-lg" id="searchCameraBtn"
                                        style="display: none;">
                                        <i class="fas fa-search me-2"></i>Buscar com Esta Foto
                                    </button>
                                </div>
                            </div>

                            <!-- Upload -->
                            <div class="tab-pane fade" id="upload" role="tabpanel">
                                <form action="{{ url_for('image_search.upload_and_search') }}" method="POST"
                                    enctype="multipart/form-data" id="imageUploadForm">
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-upload me-2"></i>Selecione uma imagem
                                        </label>
                                        <input type="file" class="form-control form-control-lg" name="image"
                                            id="imageInput"
                                            accept="image/png, image/jpeg, image/jpg, image/gif, image/webp" required>
                                        <small class="text-muted">
                                            Formatos: PNG, JPG, JPEG, GIF, WEBP (máx. 10MB)
                                        </small>
                                    </div>

                                    <!-- Preview -->
                                    <div id="imagePreview" class="mb-4" style="display: none;">
                                        <label class="form-label fw-bold">Preview:</label>
                                        <div class="text-center p-3 border rounded bg-light">
                                            <img id="previewImg" src="" alt="Preview" class="img-fluid rounded"
                                                style="max-height: 400px;">
                                        </div>
                                    </div>

                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-search me-2"></i>Buscar Produtos Similares
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h6 class="text-muted">
                                <i class="fas fa-lightbulb me-2"></i>Dicas para melhores resultados:
                            </h6>
                            <ul class="small text-muted">
                                <li>Use boa iluminação</li>
                                <li>Centralize o produto na foto</li>
                                <li>Evite fundos poluídos</li>
                                <li>Tire foto de frente</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="text-center mt-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-2">
        <i class="fas fa-brain me-2"></i>
        Analisando imagem com IA... Isso pode levar alguns segundos.
    </p>
</div>

<!-- Resultados -->
{% if products %}
<div class="row mb-3">
    <div class="col-12">
        <h4>
            <i class="fas fa-box-open me-2"></i>
            Resultados da Busca
            <span class="badge bg-primary">{{ products|length }}</span>
        </h4>
        {% if search_query %}
        <p class="text-muted">Buscando por: <strong>"{{ search_query }}"</strong></p>
        {% endif %}
    </div>
</div>

<div class="row">
    {% for product in products %}
    <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm">
            {% if product.image_file and product.image_file != 'default_product.jpg' %}
            <img src="{{ url_for('static', filename='uploads/' + product.image_file) }}" class="card-img-top"
                alt="{{ product.name }}" style="height: 200px; object-fit: cover;">
            {% else %}
            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                <i class="fas fa-image fa-3x text-muted"></i>
            </div>
            {% endif %}

            <div class="card-body">
                <h5 class="card-title">{{ product.name }}</h5>
                <p class="text-muted mb-2">
                    <i class="fas fa-tag me-1"></i>{{ product.category }}
                </p>
                <p class="card-text text-truncate">{{ product.description }}</p>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <h4 class="text-primary mb-0">R$ {{ "%.2f"|format(product.price) }}</h4>
                    <div class="text-warning">
                        <i class="fas fa-star"></i> {{ product.rating }}
                    </div>
                </div>
            </div>

            <div class="card-footer bg-white border-top-0">
                <a href="{{ url_for('products.product_detail', product_id=product.id) }}" class="btn btn-primary w-100">
                    <i class="fas fa-eye me-2"></i>Ver Detalhes
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% elif search_query %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i>
    Nenhum produto encontrado para "<strong>{{ search_query }}</strong>".
    Tente usar outras palavras-chave ou busque por imagem!
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    let cameraStream = null;
    let capturedImageBlob = null;

    // Verificar contexto seguro
    function isSecureContext() {
        return window.isSecureContext ||
            window.location.protocol === 'https:' ||
            window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1';
    }

    // Aviso se não estiver em HTTPS
    if (!isSecureContext()) {
        const cameraTab = document.getElementById('camera');
        cameraTab.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i><strong>Câmera não disponível!</strong><br>A câmera só funciona em HTTPS ou localhost.<br><br><strong>Solução:</strong> Use a aba "Fazer Upload" para escolher uma foto.</div>';
    }

    // Preview de upload
    document.getElementById('imageInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
                document.getElementById('previewImg').src = event.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Iniciar câmera
    document.getElementById('startCameraBtn').addEventListener('click', async function () {
        try {
            let constraints = {
                video: {
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            try {
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                constraints = { video: true };
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
            }

            const video = document.getElementById('cameraStream');
            video.srcObject = cameraStream;

            video.onloadedmetadata = function () {
                video.play();
                video.style.display = 'block';
                document.getElementById('startCameraBtn').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'block';
            };

        } catch (error) {
            let errorMessage = 'Erro ao acessar câmera: ';

            if (error.name === 'NotAllowedError') {
                errorMessage += 'Permissão negada.';
            } else if (error.name === 'NotFoundError') {
                errorMessage += 'Câmera não encontrada.';
            } else {
                errorMessage += error.message;
            }

            alert(errorMessage);

            if (confirm('Deseja usar upload de arquivo?')) {
                document.getElementById('upload-tab').click();
            }
        }
    });

    // Capturar foto
    document.getElementById('captureBtn').addEventListener('click', function () {
        const video = document.getElementById('cameraStream');
        const canvas = document.getElementById('photoCanvas');
        const context = canvas.getContext('2d');

        canvas.width = video.videoWidth || video.clientWidth;
        canvas.height = video.videoHeight || video.clientHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(function (blob) {
            capturedImageBlob = blob;

            const img = document.getElementById('capturedPhoto');
            img.src = URL.createObjectURL(blob);
            img.style.display = 'block';

            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            video.style.display = 'none';

            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'block';
            document.getElementById('searchCameraBtn').style.display = 'block';
        }, 'image/jpeg', 0.95);
    });

    // Tirar outra foto
    document.getElementById('retakeBtn').addEventListener('click', function () {
        document.getElementById('capturedPhoto').style.display = 'none';
        document.getElementById('retakeBtn').style.display = 'none';
        document.getElementById('searchCameraBtn').style.display = 'none';
        document.getElementById('startCameraBtn').style.display = 'block';
        capturedImageBlob = null;
    });

    // Buscar com foto da câmera
    document.getElementById('searchCameraBtn').addEventListener('click', function () {
        if (!capturedImageBlob) {
            alert('Nenhuma foto capturada!');
            return;
        }

        const formData = new FormData();
        formData.append('image', capturedImageBlob, 'camera_photo.jpg');

        document.getElementById('searchCameraBtn').disabled = true;
        document.getElementById('loadingIndicator').style.display = 'block';

        fetch('{{ url_for("image_search.upload_and_search") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else if (!response.ok) {
                    throw new Error('Erro ao processar imagem');
                }
            })
            .catch(error => {
                alert('Erro: ' + error.message);
                document.getElementById('searchCameraBtn').disabled = false;
                document.getElementById('loadingIndicator').style.display = 'none';
            });
    });

    // Loading no upload
    document.getElementById('imageUploadForm').addEventListener('submit', function () {
        document.getElementById('loadingIndicator').style.display = 'block';
    });

    // Limpar stream
    window.addEventListener('beforeunload', function () {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
    });
</script>
{% endblock %}